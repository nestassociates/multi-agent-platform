# Implementation Plan: Exportable Properties Filter

**Branch**: `002-exportable-properties-filter` | **Date**: 2025-11-21 | **Spec**: [spec.md](./spec.md)

## Summary

Filter property synchronization from Apex27 CRM to only sync properties marked as `exportable: true`. This reduces the property count from ~10,880 to ~200 by excluding valuations, pending listings, and archived properties. Implementation includes filtering in both real-time webhook handler and periodic cron sync, plus a one-time cleanup operation to remove existing non-exportable properties.

## Technical Context

**Language/Version**: TypeScript 5.3+ (Next.js 14 App Router)
**Primary Dependencies**: @supabase/supabase-js, Next.js API Routes
**Storage**: PostgreSQL (Supabase) with existing properties table
**Testing**: Jest (unit tests), Playwright (integration tests)
**Target Platform**: Vercel (Next.js serverless functions)
**Project Type**: Web application (monorepo with Turborepo)
**Performance Goals**: Webhook response <2s, Cron sync <5 min for 200 properties
**Constraints**: Must not break existing agent/admin dashboards, WordPress integration must continue working
**Scale/Scope**: ~200 exportable properties across ~10 agents, 2 sync mechanisms (webhook + cron)

## Constitution Check

*No project constitution defined - using general best practices*

✅ **All Gates Pass**:
- No constitution violations
- Standard filtering pattern
- Existing infrastructure (no new systems)
- Incremental improvement (not breaking change)

## Project Structure

### Documentation (this feature)

```text
specs/002-exportable-properties-filter/
├── spec.md              # Feature specification (completed)
├── plan.md              # This file
├── research.md          # Not needed (architecture known)
├── data-model.md        # Property filtering data flow
├── contracts/           # API changes (if any)
├── quickstart.md        # Testing and verification guide
└── tasks.md             # Generated by /speckit.tasks
```

### Source Code (existing monorepo structure)

```text
apps/dashboard/
├── app/api/
│   ├── webhooks/apex27/route.ts          # Add exportable filter
│   ├── cron/sync-properties/route.ts     # Add exportable filter
│   └── admin/properties/cleanup/route.ts # NEW - one-time cleanup endpoint
├── lib/
│   ├── apex27/
│   │   ├── types.ts                      # Already has exportable field
│   │   └── client.ts                     # No changes needed
│   └── services/
│       └── property-service.ts           # Add filtering logic

tests/
├── integration/
│   └── property-sync.test.ts             # Test filtering behavior
└── unit/
    └── property-service.test.ts          # Test filter logic
```

**Structure Decision**: Using existing monorepo structure. All changes are modifications to existing files plus one new cleanup endpoint. No new packages or major refactoring needed.

## Phase 0: Research

**Status**: ✅ Complete (No research needed)

All technical questions resolved through existing codebase analysis:
- Apex27 `exportable` field exists and is typed
- Webhook and cron infrastructure operational
- Property service supports deletion
- Database schema supports cascade deletes

## Phase 1: Design & Contracts

### Data Model

See [data-model.md](./data-model.md)

**Key Changes**:
- Properties table: No schema changes (uses existing columns)
- Filtering logic: In-memory filter before database operations
- Deletion: Hard delete via existing `deletePropertyByApex27Id()` function

**Data Flow**:
```
Apex27 Property (exportable: true/false)
    ↓
Webhook/Cron receives property data
    ↓
Check: listing.exportable === true?
    ├─→ YES: Proceed with upsert
    └─→ NO: Delete from database (if exists) or skip
    ↓
Database contains ONLY exportable properties
    ↓
Public API returns ONLY exportable properties
```

### API Contracts

No new API endpoints needed for core filtering. Optional cleanup endpoint:

**NEW Endpoint** (optional for manual cleanup):
```
POST /api/admin/properties/cleanup-non-exportable
Headers: Authorization required (admin only)
Response: {
  deleted_count: number,
  remaining_count: number,
  dry_run: boolean
}
```

**Modified Endpoints** (behavior change, not contract change):
- `POST /api/webhooks/apex27` - Now filters on exportable field
- `GET /api/cron/sync-properties` - Now skips non-exportable properties

See [contracts/](./contracts/) for detailed schemas.

### Quick Start

See [quickstart.md](./quickstart.md)

**Testing the Filter**:
1. Mark property as non-exportable in Apex27
2. Trigger webhook or wait for cron
3. Verify property is deleted from database
4. Check public API no longer returns it

**Running Cleanup**:
1. Backup database
2. Run cleanup endpoint in dry-run mode
3. Review deletion list
4. Execute actual cleanup
5. Verify property count reduced to ~200

## Implementation Phases

### Phase 0: Preparation (Completed)

✅ Confirmed `exportable` field exists in Apex27 types
✅ Verified webhook and cron infrastructure operational
✅ Confirmed deletion function exists (`deletePropertyByApex27Id`)

### Phase 1: Core Filtering

**Duration**: 1-2 hours
**Files**: 3 modifications

1. **Webhook Handler** (`app/api/webhooks/apex27/route.ts`)
   - Add exportable check in create/update case
   - If `!listing.exportable`, call `deletePropertyByApex27Id()`
   - Log filtering action

2. **Cron Sync** (`app/api/cron/sync-properties/route.ts`)
   - Add exportable filter in sync loop
   - Skip non-exportable properties
   - Track skipped count in metrics

3. **Property Service** (`lib/services/property-service.ts`)
   - Add `filterExportableProperties()` helper
   - Track filtering metrics
   - Log skipped properties

### Phase 2: One-Time Cleanup

**Duration**: 30 minutes
**Files**: 1 new file

1. **Cleanup Endpoint** (`app/api/admin/properties/cleanup/route.ts`)
   - Query all properties
   - Check exportable status (from cached Apex27 data or re-query)
   - Delete non-exportable properties
   - Support dry-run mode
   - Log all deletions

### Phase 3: Testing & Verification

**Duration**: 1 hour

1. **Unit Tests**
   - Test filtering logic in isolation
   - Test deletion when exportable changes to false

2. **Integration Tests**
   - Test webhook with non-exportable property
   - Test cron sync filters correctly
   - Test cleanup deletes correct properties

3. **Manual Verification**
   - Check property counts before/after
   - Verify WordPress shows only exportable properties
   - Monitor Sentry for any errors

## Testing Strategy

### Test Scenarios

1. **Webhook Filtering**
   - Send webhook with `exportable: false` → property not created
   - Send webhook with `exportable: true` → property created
   - Update existing property to `exportable: false` → property deleted

2. **Cron Sync Filtering**
   - Sync with mix of exportable/non-exportable → only exportable synced
   - Metrics show correct skipped count

3. **Cleanup Operation**
   - Dry-run mode shows correct deletion count
   - Actual cleanup removes non-exportable only
   - Exportable properties remain untouched

### Success Validation

- Property count: ~10,880 → ~200 ✅
- Public API returns only exportable properties ✅
- Logs show filtering metrics ✅
- No exportable properties deleted ✅

## Rollout Plan

1. **Deploy filtering code** (webhook + cron)
2. **Monitor for 24 hours** (verify no exportable properties deleted)
3. **Run cleanup in dry-run mode** (review deletion list)
4. **Execute cleanup** (delete ~10,680 properties)
5. **Verify** (check agent dashboards, WordPress)
6. **Monitor Sentry** for 48 hours

## Risks & Mitigations

**Risk**: Accidentally deleting exportable properties
**Mitigation**: Dry-run mode, database backup, logs for audit

**Risk**: Performance impact from 3 API calls per property
**Mitigation**: Filtering happens before database operations (minimal cost)

**Risk**: Cleanup takes too long or times out
**Mitigation**: Batch deletions, run during off-hours

## Notes

- This is a bug fix / data quality improvement, not a new feature
- No database schema changes required
- No new UI needed
- Immediate business impact (98% junk data removed)
